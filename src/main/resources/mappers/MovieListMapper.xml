<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rottentomatoes.movieapi.mappers.MovieListMapper">

    <sql id="offsetLimitSql">
        <choose>
            <when test="limit != null and offset != null">
                LIMIT #{offset},#{limit}
            </when>
            <when test="limit != null">
                LIMIT #{limit}
            </when>
        </choose>
    </sql>

    <select id="selectOpeningMovies" resultMap="com.rottentomatoes.movieapi.mappers.MovieMapper.movieResultMap" parameterType="map">
        SELECT
        <include refid="com.rottentomatoes.movieapi.mappers.MovieMapper.movieSelectSql"/>
        INNER JOIN movie_intl_release mir ON mir.movie_id = movie.movie_id
        INNER JOIN rating_summary rs ON rs.movie_id = mir.movie_id
        WHERE mir.release_date BETWEEN #{startDate} AND #{endDate}
        AND mir.country = #{country}
        ORDER BY mir.limited_ind DESC, rs.num_wts DESC
        <include refid="offsetLimitSql"/>
    </select>

    <select id="selectTopBoxOfficeMovies" resultMap="com.rottentomatoes.movieapi.mappers.MovieMapper.movieResultMap" parameterType="map">
        SELECT
        <include refid="com.rottentomatoes.movieapi.mappers.MovieMapper.movieSelectSql"/>
        INNER JOIN movie_box_office mbo ON mbo.movie_id = movie.movie_id
        WHERE mbo.start_date >= #{startDate}
        AND mbo.country = #{country}
        AND mbo.gross > 0
        AND mbo.estimate_ind = 0
        ORDER BY mbo.gross DESC
        <include refid="offsetLimitSql"/>
    </select>

</mapper>
