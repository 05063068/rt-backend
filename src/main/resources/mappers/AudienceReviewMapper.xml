<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.rottentomatoes.movieapi.mappers.AudienceReviewMapper">
	<sql id="selectColumns">
        rating_digest.id,
        rating_digest.movie_id,
        CONCAT(rating_digest.first_name,' ',rating_digest.last_name) AS user_name,
        rating_digest.thumbnail_url,
        rating_digest.elite_ind = 1 AS super_reviewer,
        IF(rating_digest.score > 5, (rating_digest.score - 6) * 2 + 1 , rating_digest.score * 2)/2.0 as score,
        rating_digest.comment,
        rating_digest.rating_date
	</sql>


    <select id="selectAudienceReviewsForMovie" resultMap="audienceReviewResultMap" parameterType="map">
        SELECT <include refid="selectColumns" />
        FROM rating_digest
        WHERE rating_digest.movie_id = #{movie_id}
        AND deleted_ind != 1
        ORDER BY rating_date DESC
        
        <choose>
            <when test="limit != null and offset != null">
                LIMIT #{offset},#{limit}
            </when>
            <when test="limit != null">
                LIMIT #{limit}
            </when>
        </choose>
    </select>

    <resultMap id="audienceReviewResultMap" type="com.rottentomatoes.movieapi.domain.model.AudienceReview">
        <id property="id" column="id" />
        <result property="movieId" column="movie_id" />
        <result property="userName" column="user_name" />
        <result property="superReviewer" column="super_reviewer" />
        <result property="score" column="score" />
        <result property="comment" column="comment" />   
        <result property="ratingDate" column="rating_date" />
        
        <association property="userImage" javaType="map">
            <result property="thumbnailUrl" column="thumbnail_url"/>        
        </association>
        
    </resultMap>
</mapper>

